# 10-文件管理

文件管理模块是OA系统的核心功能之一，为用户提供了完整的文件存储、管理、共享和协作功能。系统支持多种文件格式，提供直观的文件操作界面和强大的权限控制机制。

## 10.1 模块概述

### 10.1.1 功能特性
- 文件上传下载
- 文件夹创建与管理
- 文件重命名与删除
- 文件移动与复制
- 文件共享与权限控制
- 文件预览与在线查看
- 回收站管理
- 文件搜索与分类

### 10.1.2 支持的文件类型
系统支持多种文件格式：
- **文档类型**：Word、Excel、PPT、PDF、TXT等
- **图片类型**：JPG、PNG、GIF、BMP等
- **压缩文件**：ZIP、RAR、7Z等
- **其他格式**：根据系统配置支持更多格式

### 10.1.3 存储限制
- 单文件最大：500MB
- 批量上传最大：200MB
- 存储空间：按用户配额分配
- 文件名长度：最大255字符

## 10.2 文件管理主界面

### 10.2.1 进入文件管理
**访问路径**：`/filemanage`

首次进入系统会自动为用户创建个人根目录：
- 目录名称：用户名称
- 目录权限：仅用户本人可访问
- 父目录：系统根目录

**界面布局**：
```
顶部导航栏：面包屑导航 | 操作工具栏
左侧面板：目录树结构
主要区域：文件和文件夹列表
底部状态：文件统计信息
```

### 10.2.2 目录结构显示
系统采用树形结构展示用户文件：
- 根目录自动以用户名创建
- 支持多级子目录嵌套
- 显示目录层次关系
- 提供快速导航功能

### 10.2.3 文件列表视图
文件列表显示以下信息：
- 文件名称和图标
- 文件大小
- 修改时间
- 文件类型
- 操作按钮

## 10.3 文件操作功能

### 10.3.1 文件上传
**访问路径**：`/fileupload`

#### 上传流程
1. 点击"上传文件"按钮
2. 选择本地文件
3. 系统验证文件格式和大小
4. 执行上传操作
5. 显示上传结果

#### 上传限制
```java
// 文件大小验证
if (file.getSize() > MAX_FILE_SIZE) {
    return "文件大小超出限制";
}
// 文件类型验证
if (!isValidFileType(file.getContentType())) {
    return "不支持的文件类型";
}
```

#### 批量上传
- 支持同时选择多个文件
- 显示上传进度
- 处理上传失败的文件
- 提供上传结果报告

### 10.3.2 文件夹管理
**创建文件夹**：`/createpath`

创建新文件夹：
1. 点击"新建文件夹"按钮
2. 输入文件夹名称
3. 系统验证名称唯一性
4. 创建文件夹并刷新视图

**名称唯一性处理**：
```java
// 确保文件夹名称唯一
String newname = fs.onlyname(pathname, filepath, null, 1, false);
```

### 10.3.3 文件下载
**访问路径**：`/downfile`

下载功能特点：
- 支持单文件下载
- 设置正确的MIME类型
- 处理中文文件名编码
- 控制下载权限

**下载实现**：
```java
response.setContentType(filelist.getContentType());
response.setHeader("Content-Disposition", 
    "attachment;filename=" + new String(filelist.getFileName().getBytes("UTF-8"), "ISO8859-1"));
```

### 10.3.4 文件预览
**访问路径**：`/imgshow`

支持的预览类型：
- **图片预览**：直接在浏览器中显示
- **文档预览**：根据类型调用相应预览器
- **视频音频**：支持在线播放

## 10.4 文件操作管理

### 10.4.1 文件重命名
**访问路径**：`/rename`

重命名操作：
1. 选择要重命名的文件或文件夹
2. 点击"重命名"按钮
3. 输入新名称
4. 验证名称有效性
5. 执行重命名操作

**参数说明**：
- `name`：新名称
- `renamefp`：要重命名的对象ID
- `isfile`：是否为文件（true）或文件夹（false）

### 10.4.2 文件删除
**访问路径**：`/deletefile`

删除机制采用两阶段设计：
1. **逻辑删除**：文件移入回收站
2. **物理删除**：从回收站永久删除

**删除流程**：
```java
if (!checkfileids.isEmpty()) {
    // 文件放入回收站而非直接删除
    fileTransactionalHandlerService.trashfile(checkfileids, 1L, userid);
}
if (!checkpathids.isEmpty()) {
    // 删除文件夹
    fs.trashpath(checkpathids, 1L, true);
}
```

### 10.4.3 文件移动与复制
**访问路径**：`/mcto`

移动和复制功能：
- 支持文件和文件夹的移动
- 支持文件和文件夹的复制
- 处理目标路径冲突
- 维护文件权限

**操作参数**：
- `morc`：true为移动，false为复制
- `mctoid`：目标文件夹ID
- `mcfileids`：要操作的文件ID列表
- `mcpathids`：要操作的文件夹ID列表

## 10.5 文件共享功能

### 10.5.1 文件分享
**访问路径**：`/doshare`

分享机制：
1. 选择要分享的文件
2. 设置分享权限
3. 生成分享链接
4. 通知相关用户

**分享实现**：
```java
if (!checkfileids.isEmpty()) {
    fs.doshare(checkfileids);
    model.addAttribute("message", "分享成功");
}
```

### 10.5.2 权限控制
文件权限分为以下级别：
- **私有权限**：仅文件所有者可访问
- **部门权限**：部门内成员可访问
- **公开权限**：所有用户可访问
- **自定义权限**：指定用户或用户组可访问

### 10.5.3 共享文件管理
- 查看自己分享的文件
- 查看别人分享给自己的文件
- 管理分享权限
- 取消文件分享

## 10.6 高级功能

### 10.6.1 文件搜索
支持多种搜索方式：
- **文件名搜索**：按文件名模糊查询
- **文件类型筛选**：按文件扩展名筛选
- **时间范围筛选**：按创建或修改时间筛选
- **大小范围筛选**：按文件大小筛选

### 10.6.2 批量操作
支持的批量操作：
- 批量上传文件
- 批量删除文件
- 批量移动文件
- 批量复制文件
- 批量重命名
- 批量设置权限

### 10.6.3 版本管理
虽然当前版本未完全实现，但系统设计支持：
- 文件版本记录
- 版本对比
- 版本回滚
- 版本历史查看

## 10.7 回收站管理

### 10.7.1 回收站功能
- 保存被删除的文件和文件夹
- 支持文件恢复
- 定期清理过期文件
- 显示删除时间和原路径

### 10.7.2 文件恢复
从回收站恢复文件：
1. 进入回收站
2. 选择要恢复的文件
3. 指定恢复路径
4. 执行恢复操作

### 10.7.3 永久删除
从回收站永久删除：
- 不可逆操作
- 释放存储空间
- 需要确认操作
- 记录删除日志

## 10.8 数据结构

### 10.8.1 文件实体（FileList）
```java
public class FileList {
    private Long fileId;          // 文件ID
    private String fileName;      // 文件名
    private String filePath;      // 文件存储路径
    private String contentType;   // 文件MIME类型
    private Long size;            // 文件大小
    private Date uploadTime;      // 上传时间
    private FilePath path;        // 所属目录
    private User user;            // 文件所有者
    private Boolean shared;       // 是否共享
    private Boolean deleted;      // 是否删除
}
```

### 10.8.2 目录实体（FilePath）
```java
public class FilePath {
    private Long id;              // 目录ID
    private Long parentId;        // 父目录ID
    private String pathName;      // 目录名称
    private Long pathUserId;      // 目录所有者ID
    private Date createTime;      // 创建时间
    private Boolean deleted;      // 是否删除
    private List<FilePath> children; // 子目录列表
    private List<FileList> files;    // 文件列表
}
```

## 10.9 权限与安全

### 10.9.1 访问控制
- 用户只能访问自己的文件
- 共享文件按权限访问
- 管理员具有全部权限
- 支持文件夹级权限继承

### 10.9.2 安全措施
1. **文件类型检查**：
   - 验证文件MIME类型
   - 检查文件扩展名
   - 防止恶意文件上传

2. **路径安全**：
   - 防止路径遍历攻击
   - 验证文件路径合法性
   - 限制访问范围

3. **权限验证**：
   - 每个操作都有权限检查
   - 防止越权访问
   - 记录操作日志

## 10.10 性能优化

### 10.10.1 存储优化
- 文件去重机制
- 压缩存储
- 分片上传大文件
- 缓存热点文件

### 10.10.2 访问优化
- 目录结构缓存
- 分页加载文件列表
- 异步文件操作
- CDN加速静态文件

## 10.11 最佳实践

### 10.11.1 文件组织建议
1. **目录结构**：
   - 按项目或部门组织
   - 避免过深的目录嵌套
   - 使用有意义的目录名称

2. **文件命名**：
   - 使用规范的命名约定
   - 包含版本信息
   - 避免特殊字符

### 10.11.2 存储管理
1. **定期清理**：
   - 删除不需要的文件
   - 清空回收站
   - 整理文件结构

2. **备份策略**：
   - 重要文件及时备份
   - 使用版本管理
   - 异地备份关键数据

## 10.12 故障排除

### 10.12.1 上传问题
1. **上传失败**：
   - 检查文件大小限制
   - 验证文件格式
   - 检查网络连接
   - 查看存储空间

2. **权限问题**：
   - 确认用户权限
   - 检查目录权限
   - 验证文件所有权

### 10.12.2 性能问题
1. **加载缓慢**：
   - 减少单页文件数量
   - 优化图片大小
   - 检查网络带宽

2. **存储空间**：
   - 清理无用文件
   - 压缩大文件
   - 扩展存储容量

## 10.13 技术实现

### 10.13.1 控制器说明
- `FileController`：主要文件操作控制器
- `FileAjaxController`：Ajax异步操作控制器
- 包含18个功能点，覆盖文件管理全部功能

### 10.13.2 关键服务
- `FileServices`：文件操作核心服务
- `FileTransactionalHandlerService`：文件事务处理服务
- 支持事务性文件操作和回滚

文件管理模块为用户提供了完整的文件存储和协作解决方案，支持安全、高效的文件管理操作，是企业级办公系统的重要组成部分。
