# 11-通讯录

通讯录模块是OA系统的重要功能，为用户提供了完整的联系人管理功能。系统支持内部通讯录和外部通讯录的统一管理，包括联系人信息维护、分类管理、共享功能等。

## 11.1 模块概述

### 11.1.1 功能特性
- 内部通讯录管理
- 外部通讯录管理
- 联系人分类管理
- 联系人信息维护
- 联系人共享功能
- 拼音索引查找
- 批量操作功能
- 头像上传管理

### 11.1.2 通讯录类型
- **内部通讯录**：系统内部用户信息，自动同步用户数据
- **外部通讯录**：外部联系人信息，用户自行维护

### 11.1.3 联系人信息
支持管理的联系人信息包括：
- 基本信息：姓名、电话、邮箱、职位
- 详细信息：公司、部门、地址、备注
- 扩展信息：头像、拼音、分类标签

## 11.2 通讯录管理主界面

### 11.2.1 通讯录管理入口
**访问路径**：`/addrmanage`

通讯录主界面提供：
- 内外部通讯录统一视图
- 联系人分类导航
- 快速搜索功能
- 批量操作工具
- 待处理共享消息提醒

**界面统计信息**：
```java
// 统计待处理的共享消息
List<DirectorUser> nothandles = auDao.findByUserAndShareuserNotNullAndHandle(user, false);
model.addAttribute("count", nothandles.size());
```

### 11.2.2 分类管理
系统自动提取用户的联系人分类：
```java
Set<String> catalogs = auDao.findByUser(user);
```
- 显示用户自定义分类
- 支持分类的增删改操作
- 提供分类统计信息

## 11.3 内部通讯录

### 11.3.1 内部通讯录查看
**访问路径**：`/inaddresspaging`

内部通讯录功能：
- 显示系统内所有用户
- 支持分页浏览
- 提供搜索功能
- 支持拼音索引查找

**搜索和筛选**：
- **关键词搜索**：按姓名或拼音搜索
- **拼音索引**：按首字母快速定位
- **部门筛选**：按部门过滤用户
- **组合查询**：多条件组合搜索

**查询实现**：
```java
if (StringUtils.isEmpty(baseKey)) {
    if ("ALL".equals(alph)) {
        userspage = uDao.findAll(pa);
    } else {
        userspage = uDao.findByPinyinLike(alph + "%", pa);
    }
} else {
    if ("ALL".equals(alph)) {
        userspage = uDao.findUsers("%" + baseKey + "%", baseKey + "%", pa);
    } else {
        userspage = uDao.findSelectUsers("%" + baseKey + "%", alph + "%", pa);
    }
}
```

### 11.3.2 内部联系人详情
**访问路径**：`/inmessshow`

查看内部联系人详情：
- 显示用户基本信息
- 显示部门和职位信息
- 显示联系方式
- 提供操作按钮（发送邮件、添加到外部通讯录等）

## 11.4 外部通讯录

### 11.4.1 外部通讯录管理
**访问路径**：`/outaddresspaging`

外部通讯录功能：
- 显示用户添加的外部联系人
- 支持分类管理
- 提供拼音索引
- 支持搜索和筛选

**查询参数**：
- `alph`：拼音索引字母
- `outtype`：联系人分类
- `baseKey`：搜索关键词

### 11.4.2 添加外部联系人
**访问路径**：`/addaddress`

添加联系人流程：
1. 点击"添加联系人"按钮
2. 填写联系人基本信息
3. 选择或创建联系人分类
4. 上传联系人头像（可选）
5. 保存联系人信息

**表单字段**：
- **姓名**：必填项
- **电话**：联系电话
- **邮箱**：电子邮箱
- **公司**：所属公司
- **职位**：工作职位
- **地址**：联系地址
- **备注**：补充信息
- **分类**：联系人分类

### 11.4.3 保存外部联系人
**访问路径**：`/savaaddress`

保存处理逻辑：
```java
// 生成拼音索引
String pinyin = PinyinHelper.convertToPinyinString(director.getUserName(), "", PinyinFormat.WITHOUT_TONE);
director.setPinyin(pinyin);

// 处理头像上传
if (file.getSize() > 0) {
    Attachment attaid = mservice.upload(file, user);
    director.setAttachment(att.getAttachmentId());
}

// 保存联系人和用户关系
directorUser.setDirector(director);
directorUser.setUser(user);
addressService.sava(director);
addressUserService.save(directorUser);
```

### 11.4.4 外部联系人详情
**访问路径**：`/outmessshow`

查看外部联系人详情：
- 显示联系人完整信息
- 显示联系人头像
- 提供编辑和删除操作
- 支持联系人共享

**权限验证**：
```java
DirectorUser du = auDao.findByDirectorAndUser(d, user);
if (Objects.isNull(d) || Objects.isNull(du)) {
    return "redirect:/notlimit"; // 权限不足
}
```

## 11.5 联系人分类管理

### 11.5.1 分类操作
**添加分类**：`/addtypename`
- 创建新的联系人分类
- 修改现有分类名称
- 分类名称唯一性验证

**删除分类**：`/deletetypename`
- 删除指定分类
- 将该分类下的联系人移至默认分类
- 批量更新联系人分类

**修改分类**：`/changetypename`
- 批量修改联系人分类
- 更新所有相关联系人记录

### 11.5.2 联系人分类调整
**访问路径**：`/changethistype`

单个联系人分类调整：
```java
Director d = addressDao.findOne(did);
DirectorUser du = auDao.findByDirectorAndUser(d, user);
du.setCatalogName(catalog);
addressUserService.save(du);
```

## 11.6 联系人共享功能

### 11.6.1 共享联系人
**访问路径**：`/shareother`

共享联系人给其他用户：
1. 选择要共享的联系人
2. 选择接收共享的用户
3. 系统创建共享关系
4. 通知接收用户

**共享逻辑**：
```java
for (int i = 0; i < directors.length; i++) {
    User shareuser = uDao.findOne(directors[i]);
    DirectorUser du = auDao.findByDirectorAndUser(director, shareuser);
    if (Objects.isNull(du)) {
        // 创建新的共享关系
        DirectorUser dir = new DirectorUser();
        dir.setUser(shareuser);
        dir.setShareuser(user);
        dir.setDirector(director);
        dus.add(dir);
    }
}
```

### 11.6.2 接收共享消息
**访问路径**：`/sharemess`

接收到的共享联系人：
- 显示他人共享的联系人
- 支持接受或拒绝共享
- 可设置联系人分类
- 显示共享者信息

**处理共享**：
```java
if (!StringUtils.isEmpty(duid)) {
    DirectorUser du = auDao.findOne(duid);
    du.setCatalogName(catalog);
    du.setHandle(true); // 标记为已处理
    addressUserService.save(du);
}
```

### 11.6.3 我的共享记录
**访问路径**：`/mesharemess`

查看自己的共享记录：
- 显示共享给其他人的联系人
- 显示共享状态
- 支持取消共享
- 查看接收者信息

## 11.7 联系人搜索功能

### 11.7.1 搜索功能
支持多种搜索方式：
- **姓名搜索**：按联系人姓名搜索
- **拼音搜索**：按拼音首字母搜索
- **分类筛选**：按联系人分类筛选
- **组合搜索**：多条件组合查询

### 11.7.2 拼音索引
系统自动为联系人生成拼音索引：
- 支持中文姓名自动转拼音
- 按拼音首字母分组显示
- 提供字母导航栏
- 快速定位联系人

## 11.8 联系人操作管理

### 11.8.1 编辑联系人
联系人信息可随时编辑：
- 修改基本信息
- 更新联系方式
- 调整分类归属
- 更换联系人头像

### 11.8.2 删除联系人
**访问路径**：`/deletedirector`

删除联系人的处理逻辑：
```java
List<DirectorUser> dires = auDao.findByDirector(director);
if (dires.size() == 1) {
    // 最后一个拥有者删除时，删除联系人信息
    addressService.deleteDirector(du.getDirector());
} else {
    // 多个拥有者时，仅删除关联关系
    addressUserService.deleteObj(du);
}
```

### 11.8.3 批量操作
支持的批量操作：
- 批量删除联系人
- 批量调整分类
- 批量共享联系人
- 批量导出联系人

## 11.9 数据结构

### 11.9.1 联系人实体（Director）
```java
public class Director {
    private Long directorId;      // 联系人ID
    private String userName;      // 姓名
    private String phone;         // 电话
    private String email;         // 邮箱
    private String company;       // 公司
    private String position;      // 职位
    private String address;       // 地址
    private String remark;        // 备注
    private String pinyin;        // 拼音
    private Long attachment;      // 头像附件ID
    private User myuser;          // 创建者
}
```

### 11.9.2 用户联系人关系（DirectorUser）
```java
public class DirectorUser {
    private Long directorUserId;  // 关系ID
    private Director director;    // 联系人对象
    private User user;            // 用户对象
    private User shareuser;       // 共享者
    private String catalogName;   // 分类名称
    private Boolean handle;       // 是否已处理
    private Date sharetime;       // 共享时间
}
```

## 11.10 权限与安全

### 11.10.1 权限控制
- **查看权限**：用户只能查看自己的联系人和被共享的联系人
- **编辑权限**：只能编辑自己创建的联系人
- **删除权限**：只能删除自己的联系人关系
- **共享权限**：只能共享自己的联系人

### 11.10.2 数据安全
- 联系人信息加密存储
- 头像文件安全管理
- 共享权限严格控制
- 操作日志记录

## 11.11 最佳实践

### 11.11.1 联系人管理建议
1. **信息维护**：
   - 及时更新联系人信息
   - 使用统一的命名规范
   - 定期清理无效联系人

2. **分类管理**：
   - 建立合理的分类体系
   - 避免分类过于细化
   - 定期整理分类结构

### 11.11.2 共享管理
1. **共享策略**：
   - 按需共享联系人
   - 设置合适的权限
   - 及时处理共享消息

2. **隐私保护**：
   - 注意敏感信息保护
   - 谨慎共享个人联系人
   - 定期检查共享权限

## 11.12 故障排除

### 11.12.1 常见问题
1. **搜索不到联系人**：
   - 检查搜索关键词
   - 确认分类筛选条件
   - 验证权限设置

2. **共享失败**：
   - 检查目标用户是否存在
   - 确认共享权限
   - 查看网络连接状态

3. **头像上传失败**：
   - 检查文件格式
   - 确认文件大小
   - 验证存储空间

### 11.12.2 性能优化
1. **搜索优化**：
   - 建立拼音索引
   - 优化查询语句
   - 使用分页显示

2. **数据管理**：
   - 定期清理无用数据
   - 压缩头像文件
   - 优化数据库结构

## 11.13 技术实现

### 11.13.1 控制器说明
- `AddrController`：通讯录主要功能控制器
- 包含17个功能点，覆盖通讯录管理全部功能

### 11.13.2 关键服务
- `AddressService`：联系人管理核心服务
- `AddreddUserService`：用户联系人关系服务
- 支持复杂的关系管理和权限控制

### 11.13.3 拼音处理
使用jpinyin库实现拼音转换：
```java
String pinyin = PinyinHelper.convertToPinyinString(director.getUserName(), "", PinyinFormat.WITHOUT_TONE);
```

通讯录模块为用户提供了完整的联系人管理解决方案，支持内外部联系人的统一管理，提供了强大的分类、搜索和共享功能，是企业级办公系统不可缺少的重要组成部分。
