# 09-邮件系统

邮件系统是OA系统的重要组成部分，支持内部邮件通信和外部邮件收发。系统集成了邮件账户管理、邮件撰写发送、邮件接收处理等完整功能。

## 9.1 模块概述

### 9.1.1 功能特性
- 多邮箱账户管理
- 邮件撰写与发送
- 邮件接收与查看
- 邮件分类管理
- 附件上传下载
- 邮件搜索过滤
- 批量操作功能

### 9.1.2 邮件类型
- **内部邮件**：OA系统内部用户间的邮件
- **外部邮件**：与外部邮箱的邮件收发
- **系统邮件**：系统自动生成的邮件

### 9.1.3 邮箱分类
- **收件箱**：接收的所有邮件
- **发件箱**：已发送的邮件
- **草稿箱**：保存的草稿邮件
- **垃圾箱**：已删除的邮件

## 9.2 邮件首页

### 9.2.1 邮件主界面
**访问路径**：`/mail`

邮件主界面提供全面的邮件概览：
- 收件箱邮件列表
- 邮件统计信息
- 快速操作入口
- 邮件状态显示

**统计信息**：
- 未读邮件数量
- 未发送草稿数量
- 已发送邮件数量
- 垃圾箱邮件数量

### 9.2.2 邮件列表显示
邮件列表包含以下信息：
- 发送者/接收者姓名
- 邮件主题
- 发送时间
- 邮件状态（已读/未读）
- 重要性标记
- 附件标识

## 9.3 邮件撰写与发送

### 9.3.1 撰写邮件
**访问路径**：`/wmail`

撰写邮件界面包含：
- **收件人选择**：支持内部用户和外部邮箱
- **邮件主题**：必填项，建议简洁明确
- **邮件内容**：支持富文本编辑
- **附件上传**：支持多种文件格式
- **发送设置**：选择发送邮箱账户

#### 收件人选择方式
1. **手动输入**：直接输入邮箱地址
2. **通讯录选择**：从系统通讯录选择用户
3. **历史记录**：使用最近联系人

#### 邮件格式要求
```java
// 邮件实体结构
public class Inmaillist {
    private String mailTitle;     // 邮件标题
    private String content;       // 邮件内容
    private String inReceiver;    // 收件人
    private Long mailType;        // 邮件类型
    private Long mailStatusid;    // 邮件状态
    private User mailUserid;      // 发送用户
    private Mailnumber mailNumberid; // 发送账户
    private Attachment mailFileid;   // 附件信息
    private Boolean push;         // 发送状态
}
```

### 9.3.2 邮件发送
**访问路径**：`/pushmail`

发送流程：
1. 表单验证（标题、收件人必填）
2. 处理附件上传
3. 保存邮件到数据库
4. 执行发送操作
5. 更新发送状态

**发送逻辑**：
```java
// 内部邮件处理
if (mservice.isContainChinese(mail.getInReceiver())) {
    StringTokenizer st2 = new StringTokenizer(mail.getInReceiver(), ";");
    while (st2.hasMoreElements()) {
        User reciver = udao.findid(st2.nextToken());
        Mailreciver mreciver = new Mailreciver();
        mreciver.setMailId(imail);
        mreciver.setReciverId(reciver);
        mrdao.save(mreciver);
    }
} else {
    // 外部邮件发送
    mservice.pushmail(account, password, receiver, userName, title, content, attachmentPath, attachmentName);
}
```

### 9.3.3 草稿保存
- 邮件内容可随时保存为草稿
- 草稿不指定收件人时自动保存
- 草稿可继续编辑后发送

## 9.4 邮件接收与管理

### 9.4.1 收件箱管理
**访问路径**：`/mail` 或 `/amail?title=收件箱`

收件箱功能：
- 显示所有接收的邮件
- 标记已读/未读状态
- 支持邮件排序
- 提供批量操作

### 9.4.2 邮件查看
**访问路径**：`/smail`

查看邮件详情：
1. 点击邮件标题进入详情页
2. 自动标记邮件为已读
3. 显示完整邮件内容
4. 支持附件下载
5. 提供回复功能

**查看界面要素**：
- 发送者信息
- 邮件主题和时间
- 邮件正文内容
- 附件列表
- 操作按钮（回复、转发、删除）

### 9.4.3 邮件状态管理
邮件状态通过中间表`Mailreciver`管理：
- `read`：已读状态
- `star`：重要标记
- `del`：删除状态

## 9.5 邮件分类与操作

### 9.5.1 邮箱类型切换
**访问路径**：`/amail` 或 `/mailtitle`

支持的邮箱类型：
- **收件箱**：接收的邮件
- **发件箱**：已发送的邮件
- **草稿箱**：未发送的草稿
- **垃圾箱**：已删除的邮件

### 9.5.2 批量操作
**删除邮件**：`/alldelete`
- 支持批量选择邮件
- 不同邮箱类型删除逻辑不同
- 提供权限验证

**标记操作**：`/star`
- 批量标记重要邮件
- 取消重要标记
- 支持所有邮箱类型

**已读操作**：`/watch`
- 批量标记已读/未读
- 仅支持收件箱和垃圾箱

### 9.5.3 邮件恢复
**访问路径**：`/refresh`

垃圾箱邮件恢复功能：
- 将删除的邮件恢复到收件箱
- 仅限本人删除的邮件
- 支持批量恢复操作

## 9.6 邮箱账户管理

### 9.6.1 账户管理界面
**访问路径**：`/accountmanage`

邮箱账户管理功能：
- 查看所有邮箱账户
- 账户状态管理
- 支持分页显示
- 提供搜索功能

**账户信息显示**：
- 邮箱地址
- 账户名称
- 邮箱类型
- 账户状态
- 创建时间

### 9.6.2 添加/编辑邮箱账户
**访问路径**：`/addaccount`

#### 新增邮箱账户
1. 点击"添加账户"按钮
2. 填写账户信息：
   - **邮箱地址**：完整的邮箱地址
   - **用户名**：显示名称
   - **密码**：邮箱密码或授权码
   - **邮箱类型**：选择邮箱类型
   - **账户描述**：账户说明
3. 保存账户配置

#### 外部邮箱配置
**常见邮箱配置示例**：

| 邮箱类型 | SMTP服务器 | 端口 | 安全类型 |
|---------|------------|------|----------|
| QQ邮箱 | smtp.qq.com | 465 | SSL |
| 163邮箱 | smtp.163.com | 465 | SSL |
| Gmail | smtp.gmail.com | 587 | TLS |
| 企业邮箱 | 根据企业配置 | 25/465/587 | SSL/TLS |

**配置注意事项**：
1. 使用授权码而非登录密码
2. 确保SMTP服务已开启
3. 检查防火墙设置
4. 验证服务器地址和端口

### 9.6.3 账户删除
**访问路径**：`/dele`

删除邮箱账户：
- 只能删除自己创建的账户
- 删除前确认账户无未处理邮件
- 删除操作不可撤销

## 9.7 邮件搜索与过滤

### 9.7.1 邮件搜索
**访问路径**：`/mailtitle`

支持的搜索条件：
- **关键词搜索**：在标题和内容中搜索
- **发送者搜索**：按发送者姓名搜索
- **时间范围**：按时间段筛选
- **邮件状态**：按已读/未读筛选

### 9.7.2 用户搜索
**访问路径**：`/names`

内部用户搜索功能：
- 按用户姓名搜索
- 按部门筛选
- 支持模糊查询
- 显示用户详细信息

## 9.8 数据结构

### 9.8.1 邮件实体（Inmaillist）
```java
public class Inmaillist {
    private Long mailId;          // 邮件ID
    private String mailTitle;     // 邮件标题
    private String content;       // 邮件内容
    private String inReceiver;    // 收件人
    private Date mailCreateTime;  // 创建时间
    private Boolean push;         // 发送状态
    private Boolean del;          // 删除状态
    private Boolean star;         // 重要标记
    private User mailUserid;      // 发送用户
    private Mailnumber mailNumberid; // 发送账户
    private Attachment mailFileid;   // 附件
}
```

### 9.8.2 邮箱账户（Mailnumber）
```java
public class Mailnumber {
    private Long mailNumberId;    // 账户ID
    private String mailAccount;   // 邮箱地址
    private String password;      // 邮箱密码
    private String mailUserName;  // 用户名
    private String mailDes;       // 账户描述
    private Long mailType;        // 邮箱类型
    private Long status;          // 账户状态
    private Date mailCreateTime;  // 创建时间
    private User mailUserId;      // 所属用户
}
```

### 9.8.3 邮件收件人关系（Mailreciver）
```java
public class Mailreciver {
    private Long id;              // 关系ID
    private Inmaillist mailId;    // 邮件对象
    private User reciverId;       // 收件人
    private Boolean read;         // 已读状态
    private Boolean star;         // 重要标记
    private Boolean del;          // 删除状态
}
```

## 9.9 权限与安全

### 9.9.1 权限控制
- **账户管理**：用户只能管理自己的邮箱账户
- **邮件操作**：只能操作与自己相关的邮件
- **查看权限**：发送者和接收者可查看邮件
- **删除权限**：发送者可删除发件箱邮件，接收者可删除收件箱邮件

### 9.9.2 安全措施
1. **密码保护**：邮箱密码加密存储
2. **权限验证**：每个操作都有权限验证
3. **防止注入**：参数验证和SQL注入防护
4. **附件安全**：文件类型和大小限制

## 9.10 最佳实践

### 9.10.1 邮件编写建议
1. **主题明确**：
   - 简洁描述邮件内容
   - 突出重点信息
   - 避免空主题

2. **内容规范**：
   - 结构清晰，段落分明
   - 重要信息突出显示
   - 礼貌用词，专业表达

### 9.10.2 账户配置建议
1. **安全配置**：
   - 使用强密码或授权码
   - 定期更新密码
   - 启用两步验证

2. **性能优化**：
   - 定期清理无用邮件
   - 合理使用附件
   - 避免大量抄送

## 9.11 故障排除

### 9.11.1 发送失败问题
1. **检查账户配置**：
   - 验证邮箱地址和密码
   - 确认SMTP设置
   - 检查网络连接

2. **权限问题**：
   - 确认邮箱授权状态
   - 检查SMTP服务开启状态
   - 验证防火墙设置

### 9.11.2 接收异常问题
1. **内部邮件**：
   - 检查用户关系配置
   - 确认数据库连接
   - 查看系统日志

2. **外部邮件**：
   - 检查POP3/IMAP配置
   - 确认邮箱授权
   - 验证网络连接

## 9.12 技术实现

### 9.12.1 控制器说明
- `MailController`：邮件主要功能控制器
- 包含16个功能点，覆盖邮件系统全部功能

### 9.12.2 关键服务
- `MailServices`：邮件核心业务服务
- `mservice.pushmail()`：邮件发送方法
- `mservice.upload()`：附件处理方法

邮件系统为企业提供了完整的邮件通信解决方案，支持内外部邮件的统一管理，提高了沟通效率和信息安全性。